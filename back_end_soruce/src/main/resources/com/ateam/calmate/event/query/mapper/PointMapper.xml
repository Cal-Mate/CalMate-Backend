<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ateam.calmate.event.query.mapper.PointQueryRepository">

    <!-- =========================================================
         ResultMaps
         ========================================================= -->
    <!-- point_log 조회용 -->
    <resultMap id="PointLogViewMap" type="com.ateam.calmate.event.query.dto.point.PointLogViewDTO">
        <id     column="point_log_id"    property="pointLogId"/>
        <result column="member_id"       property="memberId"/>
        <result column="delta"           property="delta"/>
        <!-- ENUM 문자열 매핑 (기본 EnumTypeHandler 사용) -->
        <result column="distinction"     property="distinction"  jdbcType="VARCHAR"/>
        <result column="source_domain"   property="sourceDomain" jdbcType="VARCHAR"/>
        <result column="source_id"       property="sourceId"/>
        <result column="reason"          property="reason"/>
        <result column="idempotency_key" property="idempotencyKey"/>
        <result column="created_at"      property="createdAt"/>
    </resultMap>

    <!-- point_balance 조회용 -->
    <resultMap id="MemberBalanceMap" type="com.ateam.calmate.event.query.dto.point.MemberBalanceDTO">
        <id     column="member_id"  property="memberId"/>
        <result column="balance"    property="balance"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <!-- 멱등키 존재 확인용(경량) -->
    <resultMap id="IdemCheckMap" type="com.ateam.calmate.event.query.dto.point.IdempotentLogCheckDTO">
        <id     column="point_log_id"    property="pointLogId"/>
        <result column="member_id"       property="memberId"/>
        <result column="idempotency_key" property="idempotencyKey"/>
        <result column="created_at"      property="createdAt"/>
    </resultMap>

    <!-- =========================================================
         SELECTs (조회 전용)
         ========================================================= -->

    <!-- 1) 멤버 잔액 단건 조회 -->
    <select id="selectMemberBalance" parameterType="long" resultMap="MemberBalanceMap">
        SELECT
        pb.member_id  AS member_id,
        pb.balance    AS balance,
        pb.updated_at AS updated_at
        FROM point_balance pb
        WHERE pb.member_id = #{memberId}
    </select>

    <!-- 2) 멤버 로그 페이지 조회 (필터/기간/정렬/페이지네이션) -->
    <select id="selectPointLogsByMember" parameterType="map" resultMap="PointLogViewMap">
        SELECT
        pl.point_log_id    AS point_log_id,
        pl.member_id       AS member_id,
        pl.delta           AS delta,
        pl.distinction     AS distinction,
        pl.source_domain   AS source_domain,
        pl.source_id       AS source_id,
        pl.reason          AS reason,
        pl.idempotency_key AS idempotency_key,
        pl.created_at      AS created_at
        FROM point_log pl
        WHERE pl.member_id = #{memberId}
        <if test="distinction != null">
            AND pl.distinction = #{distinction}
        </if>
        <if test="sourceDomain != null">
            AND pl.source_domain = #{sourceDomain}
        </if>
        <if test="startAt != null">
            AND pl.created_at &gt;= #{startAt}
        </if>
        <if test="endAt != null">
            AND pl.created_at &lt;= #{endAt}
        </if>
        ORDER BY
        <choose>
            <when test="orderBy != null">
                ${orderBy}  <!-- 예: created_at DESC  (화이트리스트 검증 권장) -->
            </when>
            <otherwise>
                pl.created_at DESC
            </otherwise>
        </choose>
        <if test="limit != null">
            LIMIT #{limit}
            <if test="offset != null">
                OFFSET #{offset}
            </if>
        </if>
    </select>

    <!-- 3) 포인트 로그 단건 조회(by PK) -->
    <select id="selectPointLogById" parameterType="long" resultMap="PointLogViewMap">
        SELECT
        pl.point_log_id    AS point_log_id,
        pl.member_id       AS member_id,
        pl.delta           AS delta,
        pl.distinction     AS distinction,
        pl.source_domain   AS source_domain,
        pl.source_id       AS source_id,
        pl.reason          AS reason,
        pl.idempotency_key AS idempotency_key,
        pl.created_at      AS created_at
        FROM point_log pl
        WHERE pl.point_log_id = #{pointLogId}
    </select>

    <!-- 4) 멱등키로 기존 로그 조회 (중복요청 식별) -->
    <select id="selectLogByIdempotencyKey" parameterType="map" resultMap="IdemCheckMap">
        SELECT
        pl.point_log_id    AS point_log_id,
        pl.member_id       AS member_id,
        pl.idempotency_key AS idempotency_key,
        pl.created_at      AS created_at
        FROM point_log pl
        WHERE pl.member_id = #{memberId}
        AND pl.idempotency_key = #{idempotencyKey}
        LIMIT 1
    </select>

    <!-- 5) 멤버별 최근 N건 요약 (필요 시) -->
    <select id="selectLatestLogs" parameterType="map" resultMap="PointLogViewMap">
        SELECT
        pl.point_log_id    AS point_log_id,
        pl.member_id       AS member_id,
        pl.delta           AS delta,
        pl.distinction     AS distinction,
        pl.source_domain   AS source_domain,
        pl.source_id       AS source_id,
        pl.reason          AS reason,
        pl.idempotency_key AS idempotency_key,
        pl.created_at      AS created_at
        FROM point_log pl
        WHERE pl.member_id = #{memberId}
        ORDER BY pl.created_at DESC
        LIMIT #{limit}
    </select>

</mapper>